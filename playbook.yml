---
- name: General Tasks
  hosts: default
  become: true
  remote_user: vagrant
  become_user: root
  tasks:
    - name: Set authorized key taken from file
      authorized_key:
        user: vagrant
        state: present
        key: "{{ lookup('file', '.ssh/insecure_rsa.pub') }}"

    - name: Update /etc/hosts files for fake DNS
      blockinfile:
        block: "{{ lookup('ansible.builtin.file', 'dns.block') }}"
        path: /etc/hosts
        backup: yes

    - name: Avoid vagrant trap with too many keys
      community.general.ini_file:
        path: /etc/ssh/sshd_config
        section:
        option: MaxAuthTries
        value: '50'
        backup: yes

    # Updating all packages is very slow
    - name: Upgrade all packages
      yum:
        name: '*'
        update_cache: yes
        state: latest

    - name: Add repository
      yum_repository:
        name: elastic
        description: Elasticsearch repository for 7.x packages
        baseurl: https://artifacts.elastic.co/packages/7.x/yum

    - name: Install java and packages
      yum:
        name:
          - avahi
          - avahi-dnsconfd
          - avahi-tools
          - bzip2
          - epel-release
          - gcc
          - java-11-openjdk
          - java-11-openjdk-devel
          - kernel-devel
          - kernel-headers
          - make
          - mlocate
          - net-tools
          - perl
          - vim

    - name: Install Docker
      shell: |
        sudo yum install -y yum-utils
        sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
        sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
        sudo systemctl start docker

    - name: status
      copy:
          mode: 0755
          dest: /usr/bin/status
          content: |
            #! /usr/bin/bash
            sudo systemctl status reflex.service

    - name: start
      copy:
        mode: 0755
        dest: /usr/bin/start
        content: |
          #! /usr/bin/bash
          sudo systemctl start reflex.service

    - name: restart
      copy:
        mode: 0755
        dest: /usr/bin/restart
        content: |
          #! /usr/bin/bash
          sudo systemctl restart reflex.service

    - name: stop
      copy:
        mode: 0755
        dest: /usr/bin/stop
        content: |
          #! /usr/bin/bash
          sudo systemctl stop reflex.service

    - name: log
      copy:
        mode: 0755
        dest: /usr/bin/log
        content: |
          #! /usr/bin/bash
          less +F /opt/reflex/data/log/reflex.log


# Vagrant has been switching the hostname so they no longer match the box names
# This happens in provisioning.
- hosts: node1
  become: true
  remote_user: vagrant
  tasks:
    - name: 'hostname for node1'
      import_role:
        name: hostname
      vars:
        hostnamex: 'node1'

- hosts: node2
  become: true
  remote_user: vagrant
  tasks:
    - name: 'hostname for node2'
      import_role:
        name: hostname
      vars:
        hostnamex: 'node2'


- name: Install Reflex
  hosts: default
  remote_user: vagrant
  become: true
  become_user: root
  tasks:
    - name: find
      find:
        paths: /vagrant
        patterns: "*.rpm"
      register: rpm_find

    # If there is no rpm file, the error message:
    # "The task includes an option with an undefined variable. The error was: list object has no element 0"
    - name: set fact
      set_fact:
        rpm_file: "{{ rpm_find.files[0].path }}"

    - name: Installing RPM file
      debug: msg="{{ rpm_file }}"

    - name: Install RPM
      yum:
        name: "{{ rpm_file }}"


## THE CONFIG-OPTIONS.SH LACKS THE PART THAT CREATES AND STARTS THE SERVICE. Could be missing other stuff too???
#- name: "Configure Node 1"
#  hosts: node1
#  become: true
#  remote_user: vagrant
#  tasks:
#    - name: Copy and Execute the Reflex config script
#      script: sudo setup-reflex.sh