---
- name: Update All VMs
  hosts: default
  become: true
  remote_user: vagrant
  tasks:
    - name: Set authorized key taken from file
      authorized_key:
        user: vagrant
        state: present
        key: "{{ lookup('file', '.ssh/insecure_rsa.pub') }}"

    - name: Avoid vagrant trap with too many keys
      community.general.ini_file:
        path: /etc/ssh/sshd_config
        section:
        option: MaxAuthTries
        value: 50
        backup: yes

    # Updating all packages is very slow
    #    - name: Upgrade all packages
    #      yum:
    #        name: '*'
    #        update_cache: yes
    #        state: latest

    #    - name: Add repository
    #      yum_repository:
    #        name: elastic
    #        description: Elasticsearch repository for 7.x packages
    #        baseurl: https://artifacts.elastic.co/packages/7.x/yum

    - name: Install java and packages
      yum:
        name:
          - java-11-openjdk
#          - java-11-openjdk-devel
          - epel-release
          - python-qpid-proton
          - mlocate
          - perl
#          - gcc
#          - kernel-devel
#          - kernel-headers
          - make
          - bzip2


- name: Install Reflex
  hosts: default
  become: true
  remote_user: vagrant
  tasks:
    - name: DEBUG
      debug:
        msg: "OS {{ ansible_facts['os_family'] }}"

    - name: find
      find:
        paths: /vagrant
        patterns: "*.rpm"
      register: rpm_find

    # If there is no rpm file, the error message "The task includes an option with an undefined variable. The error was: list object has no element 0"
    - name: set fact
      set_fact:
        rpm_file: "{{ rpm_find.files[0].path }}"

    - name: Installing RPM file
      debug: msg="{{ rpm_file }}"

    - name: Install RPM
      yum:
        name: "{{ rpm_file }}"
      become_user: root


    - name: Update reflex user
      user:
        name: reflex
        groups: syers
        append: yes

    - name: Add sudo to reflex user
      user:
        name: reflex
        groups: wheel
        append: yes
      when: ansible_facts['os_family'] == "RedHat"

    - name: Add sudo to reflex user (deb)
      user:
        name: reflex
        groups: sudo
        append: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Remove reflex password for easy sudo
      shell: "sudo passwd -d reflex"

    - name: status
      copy:
        mode: 0755
        dest: /usr/bin/status
        content: |
          #! /usr/bin/bash
          sudo systemctl status reflex.service

    - name: start
      copy:
        mode: 0755
        dest: /usr/bin/start
        content: |
          #! /usr/bin/bash
          sudo systemctl start reflex.service

    - name: restart
      copy:
        mode: 0755
        dest: /usr/bin/restart
        content: |
          #! /usr/bin/bash
          sudo systemctl restart reflex.service

    - name: stop
      copy:
        mode: 0755
        dest: /usr/bin/stop
        content: |
          #! /usr/bin/bash
          sudo systemctl stop reflex.service

    - name: log
      copy:
        mode: 0755
        dest: /usr/bin/log
        content: |
          #! /usr/bin/bash
          tail -n200 -f /opt/reflex/data/log/reflex.log


## THE CONFIG-OPTIONS.SH LACKS THE PART THAT CREATES AND STARTS THE SERVICE. Could be missing other stuff too???
#- name: Configure Node 1
#  hosts: node1
#  become: true
#  remote_user: vagrant
#  tasks:
#    - name: Run config script
#      shell: >
#        sudo /opt/reflex/bin/configure-cluster-cli/config-options.sh
#        live
#        --siteId alpha
#        --live: "10.5.0.3"
#        --backup: "10.5.0.4"
#        --sslEnabled no
#        --iplist: "10.5.07"
#        --cluster_auth: admin
#        --externalLive: admin
#        --brokerUser: admin
#        --brokerUserPassword: admin
#        --classification: S
#        --releasability: NF
#        --doldap: no
#        --dohydra: no
#
#- name: Configure Node 2
#  hosts: node2
#  become: true
#  remote_user: vagrant
#  tasks:
#    - name: Run config script
#      shell: >
#        sudo /opt/reflex/bin/configure-cluster-cli/config-options.sh
#        backup
#        --siteId alpha
#        --live: "10.5.0.3"
#        --backup: "10.5.0.4"
#        --sslEnabled no
#        --iplist: "10.5.07"
#        --cluster_auth: admin
#        --externalLive: admin
#        --brokerUser: admin
#        --brokerUserPassword: admin
#        --classification: S
#        --releasability: NF
#        --doldap: no
#        --dohydra: no
